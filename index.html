<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ì½´ë‹¤ ìŠ¤íƒ€ì¼ ì„œë¹„ìŠ¤</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 15px; background: #f5f5f5; }
        .chat-window { height: 400px; overflow-y: auto; background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
        .user { background: #007aff; color: white; margin-left: 20%; text-align: right; }
        .ai { background: #e9e9eb; color: black; margin-right: 20%; }
        .img-preview { max-width: 100px; display: block; margin-bottom: 5px; border-radius: 5px; }
        .controls { display: flex; gap: 5px; flex-direction: column; }
        .input-row { display: flex; gap: 5px; }
        input[type="text"] { flex: 1; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        button { padding: 10px; border-radius: 5px; border: none; cursor: pointer; font-weight: bold; }
        .btn-photo { background: #34c759; color: white; }
        .btn-send { background: #007aff; color: white; }
    </style>
</head>
<body>
    <h3>ğŸ“˜ AI í•™ìŠµ ë„ìš°ë¯¸</h3>
    
    <div class="chat-window" id="chatBox">
        </div>

    <div class="controls">
        <input type="file" id="camInput" accept="image/*" capture="environment" style="display:none;">
        <button class="btn-photo" onclick="document.getElementById('camInput').click()">ğŸ“¸ ì‚¬ì§„ ì°ê¸° ë˜ëŠ” ë¬¸ì œ ì˜¬ë¦¬ê¸°</button>
        
        <div class="input-row">
            <input type="text" id="userInput" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
            <button class="btn-send" id="sendBtn">ì „ì†¡</button>
        </div>
    </div>

    <script>
        const S_URL = "https://nguwjyykgifeswobongq.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."; // ë‹˜êº¼ ì „ì²´ í‚¤
        const supabase = window.supabase.createClient(S_URL, S_KEY);

        const chatBox = document.getElementById('chatBox');

        // ë©”ì‹œì§€ í™”ë©´ì— ê·¸ë¦¬ê¸°
        function renderMsg(role, text, img = null) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            if(img) div.innerHTML += `<img src="${img}" class="img-preview">`;
            div.innerHTML += `<div>${text}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 1. ê³¼ê±° íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
        async function getHistory() {
            const { data } = await supabase.from('chat_history').select('*').order('created_at', { ascending: true });
            if(data) data.forEach(item => renderMsg(item.image_url ? 'user' : 'user', item.question, item.image_url) || renderMsg('ai', item.answer));
        }
        getHistory();

        // 2. ì‚¬ì§„ ì²˜ë¦¬ ë¡œì§
        document.getElementById('camInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result;
                renderMsg('user', "ì‚¬ì§„ ë¶„ì„ ì¤‘...", base64);

                // AIì—ê²Œ ë³´ë‚´ê¸° (Vercel API)
                const res = await fetch('/api/solve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image: base64.split(',')[1] })
                });
                const data = await res.json();
                const aiText = data.candidates[0].content.parts[0].text;

                renderMsg('ai', aiText);

                // Supabaseì— ì €ì¥
                await supabase.from('chat_history').insert([{ 
                    question: "ì‚¬ì§„ ë¶„ì„ ìš”ì²­", 
                    answer: aiText, 
                    image_url: base64 
                }]);
            };
        };

        // 3. ì±„íŒ… ì „ì†¡ ë¡œì§
        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('userInput').value;
            if(!val) return;

            renderMsg('user', val);
            document.getElementById('userInput').value = '';

            const res = await fetch('/api/solve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text: val })
            });
            const data = await res.json();
            const aiText = data.candidates[0].content.parts[0].text;

            renderMsg('ai', aiText);
            await supabase.from('chat_history').insert([{ question: val, answer: aiText }]);
        };
    </script>
</body>
</html>
