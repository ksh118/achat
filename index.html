<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ÌïôÏäµ ÎèÑÏö∞ÎØ∏</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 15px; background: #f4f7f6; }
        .chat-box { height: 450px; overflow-y: auto; background: white; border-radius: 12px; padding: 15px; border: 1px solid #ddd; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; padding: 12px; border-radius: 10px; font-size: 14px; line-height: 1.6; word-break: break-all; }
        .user { background: #007aff; color: white; margin-left: 15%; }
        .ai { background: #e9e9eb; color: black; margin-right: 15%; }
        .img-view { width: 100%; border-radius: 8px; margin-bottom: 5px; }
        .controls { display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 5px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; }
        .btn-camera { background: #34c759; color: white; font-size: 16px; }
        .btn-send { background: #007aff; color: white; width: 70px; }
    </style>
</head>
<body>
    <h3 style="text-align:center;">üìò AI Î¨∏Ï†ú Ìï¥Í≤∞ÏÇ¨</h3>
    <div class="chat-box" id="chatContainer"></div>
    <div class="controls">
        <input type="file" id="camInput" accept="image/*" capture="environment" style="display:none;">
        <button class="btn-camera" onclick="document.getElementById('camInput').click()">üì∏ ÏÇ¨ÏßÑÏúºÎ°ú Î¨∏Ï†ú ÌíÄÍ∏∞</button>
        <div class="input-row">
            <input type="text" id="userText" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
            <button class="btn-send" id="sendBtn">Ï†ÑÏÜ°</button>
        </div>
    </div>

    <script>
        const SB_URL = "https://nguwjyykgifeswobongq.supabase.co";
        const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndXdqeXlrZ2lmZXN3b2JvbmdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTY4OTMsImV4cCI6MjA4NTMzMjg5M30.3wy2nyumj3apjWpiK-u5aJEuug81Ofkk_o8oW_xw4Vg";
        const sbClient = window.supabase.createClient(SB_URL, SB_KEY);
        const chatContainer = document.getElementById('chatContainer');

        function printMsg(role, text, img = null) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            if(img) div.innerHTML += `<img src="${img}" class="img-view">`;
            div.innerHTML += `<div>${text}</div>`;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // ÌûàÏä§ÌÜ†Î¶¨ Î∂àÎü¨Ïò§Í∏∞
        (async () => {
            const { data } = await sbClient.from('chat_history').select('*').order('created_at', { ascending: true });
            if(data) data.forEach(i => {
                printMsg('user', i.question, i.image_url);
                printMsg('ai', i.answer);
            });
        })();

        // ÏÇ¨ÏßÑ Î∂ÑÏÑù ÌïµÏã¨ Î°úÏßÅ
        document.getElementById('camInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Img = reader.result;
                printMsg('user', "Ïù¥ Î¨∏Ï†úÎ•º Î∂ÑÏÑùÌï¥Ï§ò.", base64Img);

                try {
                    const response = await fetch('/api/solve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64Img.split(',')[1] })
                    });

                    const result = await response.json();
                    console.log("ÏÑúÎ≤Ñ ÏùëÎãµ Îç∞Ïù¥ÌÑ∞:", result);

                    // ÏóêÎü¨ Ï≤¥ÌÅ¨ Î∞è Îç∞Ïù¥ÌÑ∞ Ï∂îÏ∂ú (TypeError Î∞©ÏßÄ)
                    if (result.candidates && result.candidates[0] && result.candidates[0].content) {
                        const aiText = result.candidates[0].content.parts[0].text;
                        printMsg('ai', aiText);
                        await sbClient.from('chat_history').insert([{ question: "ÏÇ¨ÏßÑ Î∂ÑÏÑù", answer: aiText, image_url: base64Img }]);
                    } else {
                        throw new Error(result.error || "AI ÏùëÎãµ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");
                    }
                } catch (err) {
                    console.error("Î∂ÑÏÑù ÏóêÎü¨:", err);
                    printMsg('ai', "‚ùå ÏóêÎü¨ Î∞úÏÉù: " + err.message);
                }
            };
        };

        // ÌÖçÏä§Ìä∏ Ï†ÑÏÜ°
        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('userText').value;
            if(!val) return;
            printMsg('user', val);
            document.getElementById('userText').value = '';

            try {
                const response = await fetch('/api/solve', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: val })
                });
                const result = await response.json();
                const aiText = result.candidates[0].content.parts[0].text;
                printMsg('ai', aiText);
                await sbClient.from('chat_history').insert([{ question: val, answer: aiText }]);
            } catch (err) {
                printMsg('ai', "‚ùå ÎãµÎ≥ÄÏùÑ Í∞ÄÏ†∏Ïò§ÏßÄ Î™ªÌñàÏäµÎãàÎã§.");
            }
        };
    </script>
</body>
</html>
