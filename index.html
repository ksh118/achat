<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¬¸ì œ í’€ì´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 15px; background: #f8f9fa; }
        .chat-box { height: 400px; overflow-y: auto; background: white; border-radius: 10px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; }
        .msg { margin-bottom: 12px; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.5; }
        .user { background: #007aff; color: white; margin-left: 15%; text-align: right; }
        .ai { background: #e9e9eb; color: black; margin-right: 15%; }
        .controls { display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 5px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; color: white; }
    </style>
</head>
<body>
    <h3 style="text-align: center;">ğŸ“¸ AI í•™ìŠµ ë„ìš°ë¯¸</h3>
    <div class="chat-box" id="chatWindow"></div>
    <div class="controls">
        <input type="file" id="camera" accept="image/*" capture="environment" style="display:none;">
        <button onclick="document.getElementById('camera').click()" style="background:#28a745;">ğŸ“· ì‚¬ì§„ ì°ê¸° / ë¬¸ì œ ì„ íƒ</button>
        <div class="input-row">
            <input type="text" id="userInput" placeholder="ì¶”ê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
            <button id="sendBtn" style="background:#007aff;">ì „ì†¡</button>
        </div>
    </div>

    <script>
        const S_URL = "https://nguwjyykgifeswobongq.supabase.co";
        const S_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndXdqeXlrZ2lmZXN3b2JvbmdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTY4OTMsImV4cCI6MjA4NTMzMjg5M30.3wy2nyumj3apjWpiK-u5aJEuug81Ofkk_o8oW_xw4Vg";
        // ë³€ìˆ˜ëª… ì¤‘ë³µ ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ ê³ ìœ í•œ ì´ë¦„ ì‚¬ìš©
        const globalSupabase = window.supabase.createClient(S_URL, S_KEY);
        const chatWindow = document.getElementById('chatWindow');

        function showMsg(role, text, img = null) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            if(img) div.innerHTML += `<img src="${img}" style="width:100%; border-radius:5px; margin-bottom:5px;">`;
            div.innerHTML += `<div>${text}</div>`;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        // ê³¼ê±° ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        (async () => {
            const { data } = await globalSupabase.from('chat_history').select('*').order('created_at', { ascending: true });
            if(data) data.forEach(d => {
                showMsg('user', d.question, d.image_url);
                showMsg('ai', d.answer);
            });
        })();

        // ì‚¬ì§„ ì°ê³  ë¶„ì„í•˜ê¸°
        document.getElementById('camera').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result;
                showMsg('user', "ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...", base64);

                try {
                    const res = await fetch('/api/solve', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ image: base64.split(',')[1] })
                    });
                    const data = await res.json();
                    
                    // ì—ëŸ¬ í•¸ë“¤ë§ ì¶”ê°€
                    if (!data.candidates || data.candidates.length === 0) throw new Error("AI ë‹µë³€ ì—†ìŒ");
                    
                    const aiAnswer = data.candidates[0].content.parts[0].text;
                    showMsg('ai', aiAnswer);
                    await globalSupabase.from('chat_history').insert([{ question: "ì‚¬ì§„ ë¶„ì„", answer: aiAnswer, image_url: base64 }]);
                } catch (err) {
                    showMsg('ai', "ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì„œë²„ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                }
            };
        };

        // í…ìŠ¤íŠ¸ ì§ˆë¬¸ ì „ì†¡
        document.getElementById('sendBtn').onclick = async () => {
            const text = document.getElementById('userInput').value;
            if(!text) return;
            showMsg('user', text);
            document.getElementById('userInput').value = '';

            const res = await fetch('/api/solve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text: text })
            });
            const data = await res.json();
            const aiAnswer = data.candidates[0].content.parts[0].text;
            showMsg('ai', aiAnswer);
            await globalSupabase.from('chat_history').insert([{ question: text, answer: aiAnswer }]);
        };
    </script>
</body>
</html>
