<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI í•™ìŠµ ë„ìš°ë¯¸</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 15px; background: #f5f5f5; }
        .chat-window { height: 450px; overflow-y: auto; background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .msg { margin-bottom: 12px; padding: 12px; border-radius: 10px; font-size: 14px; line-height: 1.6; word-break: break-all; }
        .user { background: #007aff; color: white; margin-left: 15%; }
        .ai { background: #e9e9eb; color: black; margin-right: 15%; border-left: 4px solid #007aff; }
        .img-preview { max-width: 150px; display: block; margin-bottom: 8px; border-radius: 6px; }
        .controls { display: flex; flex-direction: column; gap: 8px; }
        .input-row { display: flex; gap: 8px; }
        input[type="text"] { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #ddd; outline: none; }
        button { padding: 12px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-photo { background: #34c759; color: white; font-size: 16px; }
        .btn-send { background: #007aff; color: white; width: 80px; }
        button:active { opacity: 0.7; }
    </style>
</head>
<body>
    <h3 style="text-align: center; color: #333;">ğŸ“˜ AI ë¬¸ì œ í’€ì´ ì±—</h3>
    
    <div class="chat-window" id="chatBox"></div>

    <div class="controls">
        <input type="file" id="camInput" accept="image/*" capture="environment" style="display:none;">
        <button class="btn-photo" onclick="document.getElementById('camInput').click()">ğŸ“¸ ì‚¬ì§„ ì°ê¸° / ë¬¸ì œ ì„ íƒ</button>
        
        <div class="input-row">
            <input type="text" id="userInput" placeholder="ì¶”ê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”...">
            <button class="btn-send" id="sendBtn">ì „ì†¡</button>
        </div>
    </div>

    <script>
        // ë³€ìˆ˜ ì¤‘ë³µ ë°©ì§€ë¥¼ ìœ„í•´ ì´ë¦„ì„ ëª…í™•íˆ êµ¬ë¶„í•¨
        const PROJECT_URL = "https://nguwjyykgifeswobongq.supabase.co";
        const PROJECT_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndXdqeXlrZ2lmZXN3b2JvbmdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTY4OTMsImV4cCI6MjA4NTMzMjg5M30.3wy2nyumj3apjWpiK-u5aJEuug81Ofkk_o8oW_xw4Vg";
        
        // supabase ì „ì—­ ë³€ìˆ˜ ì¤‘ë³µ ì„ ì–¸ í•´ê²°
        const mySupabase = window.supabase.createClient(PROJECT_URL, PROJECT_KEY);
        const chatBox = document.getElementById('chatBox');

        function renderMsg(role, text, img = null) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            if(img) div.innerHTML += `<img src="${img}" class="img-preview">`;
            div.innerHTML += `<div>${text}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // 1. ê³¼ê±° íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadHistory() {
            try {
                const { data, error } = await mySupabase.from('chat_history').select('*').order('created_at', { ascending: true });
                if (data) {
                    data.forEach(item => {
                        renderMsg('user', item.question, item.image_url);
                        renderMsg('ai', item.answer);
                    });
                }
            } catch (e) { console.error("íˆìŠ¤í† ë¦¬ ë¡œë”© ì‹¤íŒ¨:", e); }
        }
        loadHistory();

        // 2. ì‚¬ì§„ ë¶„ì„ í•¸ë“¤ëŸ¬
        document.getElementById('camInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64Full = reader.result;
                renderMsg('user', "ì‚¬ì§„ì„ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...", base64Full);

                try {
                    const res = await fetch('/api/solve', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ image: base64Full.split(',')[1] })
                    });
                    const data = await res.json();
                    const aiResult = data.candidates[0].content.parts[0].text;

                    renderMsg('ai', aiResult);

                    // Supabase ì €ì¥
                    await mySupabase.from('chat_history').insert([{ 
                        question: "ì‚¬ì§„ ë¶„ì„ ìš”ì²­", 
                        answer: aiResult, 
                        image_url: base64Full 
                    }]);
                } catch (err) {
                    renderMsg('ai', "ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. Vercel ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                }
            };
        };

        // 3. í…ìŠ¤íŠ¸ ì±„íŒ… í•¸ë“¤ëŸ¬
        document.getElementById('sendBtn').onclick = async () => {
            const textVal = document.getElementById('userInput').value;
            if(!textVal) return;

            renderMsg('user', textVal);
            document.getElementById('userInput').value = '';

            try {
                const res = await fetch('/api/solve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ text: textVal })
                });
                const data = await res.json();
                const aiResult = data.candidates[0].content.parts[0].text;

                renderMsg('ai', aiResult);
                await mySupabase.from('chat_history').insert([{ question: textVal, answer: aiResult }]);
            } catch (err) {
                renderMsg('ai', "ë‹µë³€ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        };
    </script>
</body>
</html>
