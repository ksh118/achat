<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Î¨∏Ï†ú ÌíÄÏù¥</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: #f8f9fa; }
        .chat-box { height: 400px; overflow-y: auto; background: white; border: 1px solid #ddd; padding: 15px; border-radius: 10px; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; padding: 10px; border-radius: 8px; font-size: 14px; }
        .user { background: #007bff; color: white; text-align: right; margin-left: 20%; }
        .ai { background: #eee; color: #333; margin-right: 20%; }
        .controls { display: flex; flex-direction: column; gap: 10px; }
        button { padding: 12px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        input[type="text"] { padding: 12px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
    </style>
</head>
<body>
    <div class="chat-box" id="chatBox"></div>
    <div class="controls">
        <input type="file" id="camInput" accept="image/*" capture="environment" style="display:none;">
        <button onclick="document.getElementById('camInput').click()" style="background:#28a745; color:white;">üì∏ ÏÇ¨ÏßÑ Ï∞çÍ∏∞ / ÏóÖÎ°úÎìú</button>
        <div style="display:flex; gap:5px;">
            <input type="text" id="userInput" placeholder="ÏßàÎ¨∏ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî...">
            <button id="sendBtn" style="background:#007bff; color:white;">Ï†ÑÏÜ°</button>
        </div>
    </div>

    <script>
        // Î≥ÄÏàòÎ™Ö Ï§ëÎ≥µÏùÑ ÌîºÌïòÍ∏∞ ÏúÑÌï¥ 'final' Ï†ëÎëêÏÇ¨ ÏÇ¨Ïö©
        const finalSUrl = "https://nguwjyykgifeswobongq.supabase.co";
        const finalSKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndXdqeXlrZ2lmZXN3b2JvbmdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTY4OTMsImV4cCI6MjA4NTMzMjg5M30.3wy2nyumj3apjWpiK-u5aJEuug81Ofkk_o8oW_xw4Vg";
        const finalClient = window.supabase.createClient(finalSUrl, finalSKey);
        const chatBox = document.getElementById('chatBox');

        function addMsg(role, text, img = null) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            if(img) div.innerHTML += `<img src="${img}" style="width:100%; border-radius:5px; margin-bottom:5px;">`;
            div.innerHTML += `<div>${text}</div>`;
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // ÌûàÏä§ÌÜ†Î¶¨ Î°úÎìú
        (async () => {
            const { data } = await finalClient.from('chat_history').select('*').order('created_at', { ascending: true });
            if(data) data.forEach(d => {
                addMsg('user', d.question, d.image_url);
                addMsg('ai', d.answer);
            });
        })();

        // ÏÇ¨ÏßÑ Î∂ÑÏÑù (Vercel API Ìò∏Ï∂ú)
        document.getElementById('camInput').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const base64 = reader.result;
                addMsg('user', "ÏÇ¨ÏßÑ Î∂ÑÏÑù Ï§ë...", base64);
                const res = await fetch('/api/solve', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ image: base64.split(',')[1] })
                });
                const data = await res.json();
                const aiMsg = data.candidates[0].content.parts[0].text;
                addMsg('ai', aiMsg);
                await finalClient.from('chat_history').insert([{ question: "ÏÇ¨ÏßÑ Î∂ÑÏÑù", answer: aiMsg, image_url: base64 }]);
            };
        };

        // Ï±ÑÌåÖ Ï†ÑÏÜ°
        document.getElementById('sendBtn').onclick = async () => {
            const val = document.getElementById('userInput').value;
            if(!val) return;
            addMsg('user', val);
            document.getElementById('userInput').value = '';
            const res = await fetch('/api/solve', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text: val })
            });
            const data = await res.json();
            const aiMsg = data.candidates[0].content.parts[0].text;
            addMsg('ai', aiMsg);
            await finalClient.from('chat_history').insert([{ question: val, answer: aiMsg }]);
        };
    </script>
</body>
</html>
