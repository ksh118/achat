<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ë¬¸ì œ í’€ì´</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 0 auto; padding: 15px; background: #f4f7f6; }
        #chat { height: 400px; overflow-y: auto; background: white; border-radius: 12px; padding: 15px; border: 1px solid #ddd; margin-bottom: 10px; }
        .msg { margin-bottom: 10px; padding: 12px; border-radius: 10px; font-size: 14px; line-height: 1.6; }
        .user { background: #007aff; color: white; margin-left: 15%; }
        .ai { background: #e9e9eb; color: black; margin-right: 15%; }
        img { width: 100%; border-radius: 8px; margin-bottom: 5px; }
        .controls { display: flex; flex-direction: column; gap: 8px; }
        button { padding: 15px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; background: #34c759; color: white; font-size: 16px; }
    </style>
</head>
<body>
    <div id="chat"></div>
    <div class="controls">
        <input type="file" id="cam" accept="image/*" capture="environment" style="display:none;">
        <button onclick="document.getElementById('cam').click()">ğŸ“· ì‚¬ì§„ ì°ê¸° (ë°”ë¡œ ì‹œì‘)</button>
    </div>

    <script>
        const SURL = "https://nguwjyykgifeswobongq.supabase.co";
        const SKEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ndXdqeXlrZ2lmZXN3b2JvbmdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NTY4OTMsImV4cCI6MjA4NTMzMjg5M30.3wy2nyumj3apjWpiK-u5aJEuug81Ofkk_o8oW_xw4Vg";
        const client = window.supabase.createClient(SURL, SKEY);

        function add(role, text, img = null) {
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            if(img) div.innerHTML += `<img src="${img}">`;
            div.innerHTML += `<div>${text}</div>`;
            document.getElementById('chat').appendChild(div);
            document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
        }

        document.getElementById('cam').onchange = async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = async () => {
                const b64 = reader.result;
                add('user', "ë¶„ì„ ì‹œì‘...", b64);

                try {
                    const res = await fetch('/api/solve', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: b64.split(',')[1] })
                    });

                    const data = await res.json();
                    
                    // í•µì‹¬ ìˆ˜ì •: AI ë‹µë³€ ì¶”ì¶œ ë°©ì‹ì„ í›¨ì”¬ ìœ ì—°í•˜ê²Œ ë°”ê¿ˆ
                    let aiText = "";
                    if (data.candidates && data.candidates[0].content) {
                        aiText = data.candidates[0].content.parts[0].text;
                    } else if (data.error) {
                        aiText = "ì—ëŸ¬ë°œìƒ: " + data.error.message;
                    } else {
                        aiText = "ì‘ë‹µ í˜•ì‹ ì˜¤ë¥˜: " + JSON.stringify(data);
                    }

                    add('ai', aiText);
                    await client.from('chat_history').insert([{ question: "ì‚¬ì§„ ë¶„ì„", answer: aiText, image_url: b64 }]);
                } catch (err) {
                    add('ai', "ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: " + err.message);
                }
            };
        };
    </script>
</body>
</html>
